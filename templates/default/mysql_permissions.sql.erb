-- THIS FILE IS AUTOMATICALLY GENERATED BY CHEF
-- DO NOT MODIFY, YOUR CHANGES WILL BE LOST

<% for db_name in @mysql_databases['databases'].keys %>
create database if not exists `<%= db_name %>`;

<% for p in @mysql_databases['databases'][db_name]['permissions'] %>
-- grant user permissions on this database
grant <%= p['permissions'].join(', ') %>
    on `<%= db_name %>`.*
    to '<%= p['username'] %>';
<% end %>

<% end %>

-- AFTER grant tables then massage the user table

<% for user in @mysql_users['users'] %>
-- User: <%= user['name'] %>

--  Remove any user accounts that may have existed before except for
-- hosts that are still able to connect
delete from mysql.user where user = '<%= user['name'] %>'
    and host not in(<%= user['hosts'].map{ |h| "'"+h+"'" }.join(", ") %>);

<% for host in user['hosts'] %>
-- insert specific user access from host <%= host %>
-- ignore duplicate keys for idempotence, this may run many times
-- on the same VM
insert IGNORE into mysql.user set
    user = '<%= user['name'] %>',
    host = '<%= host %>',
    password = password('<%= user['password'] %>');
<% end %>
<% end %>

flush privileges;
